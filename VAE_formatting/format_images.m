% -------------------------------------------------------------------------
% Author: ZAB
% DATE:   17 February 2020
% -------------------------------------------------------------------------
line='-------------------------------------------------------------------';

% location of the codes on LosertLab NAS
addpath(genpath('X:\MATLAB\ImageAnalysis'));
date                = '210302';
[saveDir,loadDir]   = getDirectories(date);
% -------------------------------------------------------------------------
%%                        LOAD IN THE EXTRACTIONS
% -------------------------------------------------------------------------
nFrames = 177;
extractions = [];
for n = 17:nFrames
    disp(['n: ',num2str(n)]); 
    load([saveDir,'extraction_',num2str(n),'.mat'],'out');
    extractions = [extractions;[out,n*ones(length(out(:,1)),1)]];
end
% -------------------------------------------------------------------------
%%                          TRACKING PARAMETERS
% -------------------------------------------------------------------------
param.dim       = 3;
param.mem       = 0;
param.good      = 161;
param.quiet     = 0;
tracks          = ubertrack(extractions,3,param);
save([saveDir,'tracks_',num2str(nFrames),'.mat'],'tracks');
% -------------------------------------------------------------------------
%%                            GENERATE BEADS
% -------------------------------------------------------------------------
n       = 177;
file    = [loadDir,'Scan_',num2str(n),'.hdf5'];

tic
data    = h5read(file,['/RawData/Scan_',num2str(n)]);
toc

disp('loaded image');
disp(line);

% Crop and threshold the image
zMin = 1;
zMax = 320;
xMin = 1;
xMax = 803;
yMin = 1;
yMax = 831;
IMS_new = data(xMin:xMax,yMin:yMax,zMin:zMax);
IMS_thr = IMS_thresh(IMS_new,99);
% -------------------------------------------------------------------------
% Band pass filter and invert image
% -------------------------------------------------------------------------
radius  = 14;
rbp     = ceil(2*radius); % size of band pass filter
IMS_filt    = bpassfilt(IMS_thr,rbp);
radius  = 13;

% out = tracks(tracks(:,13)==n,:);
load([saveDir,'extraction_',num2str(n),'.mat'],'out');
IMS = zeros([length(out(:,1)),2*radius+1,2*radius+1,2*radius+1]);
for j = 1:length(out(:,1))
    [xc,yc,zc] = isolate_chunk(out(j,:),radius);
    IMS(j,:,:,:) = IMS_filt(xc,yc,zc);
end

save([saveDir,'BEADS_',num2str(n),'.mat'],'IMS')
disp(line);
disp('Finished');
%%

ii = randi(4900);
figure(1);
imagesc(squeeze(IMS(ii,:,:,14)));
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------