% -------------------------------------------------------------------------
% Author: ZAB
% DATE:   17 February 2020
% -------------------------------------------------------------------------
line='-------------------------------------------------------------------';

% location of the codes on LosertLab NAS
addpath(genpath('X:\MATLAB\ImageAnalysis'));
date                = '210302';
[saveDir,loadDir]   = getDirectories(date);
% -------------------------------------------------------------------------
%%                        LOAD IN THE EXTRACTIONS
% -------------------------------------------------------------------------
for n = 1
    disp(['n: ',num2str(n)]); 
    load([saveDir,'xyz_',num2str(n),'.mat'],'Result');
end
% -------------------------------------------------------------------------
%%                            GENERATE BEADS
% -------------------------------------------------------------------------
n       = 1;
file    = [loadDir,'Scan_',num2str(n),'.hdf5'];

tic
data    = h5read(file,['/RawData/Scan_',num2str(n)]);
toc

disp('loaded image');
disp(line);
% -------------------------------------------------------------------------
% These are the size of the input image
% -------------------------------------------------------------------------
zMin = 1;
zMax = 326;
xMin = 1;
xMax = 816;
yMin = 1;
yMax = 849;
% -------------------------------------------------------------------------
IMS_new = data(xMin:xMax,yMin:yMax,zMin:zMax);
IMS_thr = IMS_thresh(IMS_new,99);
% -------------------------------------------------------------------------
% Band pass filter and invert image
% -------------------------------------------------------------------------
radius      = 14;
rbp         = ceil(2*radius); % size of band pass filter
IMS_filt    = bpassfilt(IMS_thr,rbp);
%%
radius      = 13;
IMS = zeros([length(Result(:,1)),2*radius+1,2*radius+1,2*radius+1]);
for j = 1:length(Result(:,1))
    [xc,yc,zc] = isolate_chunk(Result(j,:),radius);
    IMS(j,:,:,:) = IMS_filt(xc,yc,zc);
end

save([saveDir,'BEADS_',num2str(n),'.mat'],'IMS')
disp(line);
disp('Finished');
%%

ii = randi(4900);
figure(1);
imagesc(squeeze(IMS(ii,:,:,14)));
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------