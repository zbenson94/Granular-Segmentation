% -------------------------------------------------------------------------
% Author: ZAB
% DATE:   17 February 2020
% -------------------------------------------------------------------------
function [] = getBeadsforVAE(n,saveDir,loadDir,zmax,radius)
line='-------------------------------------------------------------------';
    load(sprintf('%sxyz_%04d.mat',saveDir,n),'xyzp');
    file = [loadDir,'Scan_',num2str(n),'.hdf5'];
    disp(file);
    tic; data = h5read(file,['/RawData/Scan_',num2str(n)]); toc;
    disp('loaded image');
    % ---------------------------------------------------------------------
    % These are the size of the input image
    % ---------------------------------------------------------------------
    xlim = [1,size(data,1)];
    ylim = [1,size(data,2)];
    zlim = [1,zmax];

    IMS_new  = data(xlim(1):xlim(2),ylim(1):ylim(2),zlim(1):zlim(2));
    % Threshold the image
    IMS_thr  = IMS_thresh(IMS_new,90);
    % Band pass filter and invert image
    rbp      = ceil(2*radius); % size of band pass filter
    IMS_filt = bpassfilt(IMS_thr,rbp);
    disp('Finished with bpass filter');

    IMS = zeros([length(xyzp(:,1)),2*radius+1,2*radius+1,2*radius+1]);
    for j = 1:length(xyzp(:,1))
        [xc,yc,zc]   = isolate_chunk(xyzp(j,:),radius);
        IMS(j,:,:,:) = IMS_filt(xc,yc,zc);
    end

    save([saveDir,'BEADS_',num2str(n),'.mat'],'IMS')
    disp(line);
    disp('Finished');
end
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------