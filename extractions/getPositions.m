% -------------------------------------------------------------------------
% Author: ZAB
% DATE:   17 February 2020
% -------------------------------------------------------------------------
function [] = getPositions(n,saveDir,loadDir,zmax,radius,thresh,areathresh,IMS_filt,fname)


    if(~exist('thresh','var'))
        thresh = 20;
    end
    if(~exist('areathresh','var'))
        areathresh = 10;
    end
    if(~exist('fname','var'))
        fname = sprintf('xyz_%04d.mat',n);
    end
line='-------------------------------------------------------------------';
% -------------------------------------------------------------------------
    if(~exist('IMS_filt','var'))
        file = [loadDir,'Scan_',num2str(n),'.hdf5'];
        disp(file);
        tic; data = h5read(file,['/RawData/Scan_',num2str(n)]); toc;
        disp('loaded image');
        % Crop and threshold the image
        xlim = [1,size(data,1)];
        ylim = [1,size(data,2)];
        zlim = [1,zmax];

        IMS_new  = data(xlim(1):xlim(2),ylim(1):ylim(2),zlim(1):zlim(2));
        % Threshold the image
        IMS_thr  = IMS_thresh(IMS_new,90);
        % Band pass filter and invert image
        rbp      = ceil(2*radius); % size of band pass filter
        IMS_filt = bpassfilt(IMS_thr,rbp);
        disp('Finished with bpass filter');
        
        saveIMS = true;
    else
        saveIMS = false;
    end
    % Threshold the image
    CrIM = IMS_filt < 50e-5;
    % Apply the convolution to find the COM of the beads %% IT WAS 4
    tic
    xyzp = sphereConv(IMS_filt,CrIM,radius,1,thresh,areathresh);
    disp('Finished with the convolution');
    toc
    disp(line);
    fprintf('%sIMS_filt_%04d.mat\n',saveDir,n);
    fprintf('%s%s\n',saveDir,fname);
    save(sprintf('%s%s',saveDir,fname),'xyzp');
    if(saveIMS)
        save(sprintf('%sIMS_filt_%04d.mat',saveDir,n),'IMS_filt');
    end
end
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------