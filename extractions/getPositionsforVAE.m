% -------------------------------------------------------------------------
% Author: ZAB
% DATE:   17 February 2020
% -------------------------------------------------------------------------
function [] = getPositionsforVAE(n,saveDir,loadDir,zmax,radius,thresh,areathresh)
line='-------------------------------------------------------------------';
% -------------------------------------------------------------------------
    file = [loadDir,'Scan_',num2str(n),'.hdf5'];
    disp(file);
    tic; data = h5read(file,['/RawData/Scan_',num2str(n)]); toc;
    disp('loaded image');
    % Crop and threshold the image
    xlim = [1,size(data,1)];
    ylim = [1,size(data,2)];
    zlim = [1,zmax];
    
    IMS_new  = data(xlim(1):xlim(2),ylim(1):ylim(2),zlim(1):zlim(2));
    % Threshold the image
    IMS_thr  = IMS_thresh(IMS_new,90);
    % Band pass filter and invert image
    rbp      = ceil(2*radius); % size of band pass filter
    IMS_filt = bpassfilt(IMS_thr,rbp);
    disp('Finished with bpass filter');
    
    % Threshold the image
    CrIM = IMS_filt < 1e-5;
    % Apply the convolution to find the COM of the beads %% IT WAS 4
    tic
    xyzp = sphereConv(IMS_filt,CrIM,radius,1,thresh,areathresh);
    disp('Finished with the convolution');
    toc
    disp(line);
    fprintf('%sIMS_filt_%04d.mat\n',saveDir,n);
    fprintf('%sxyz_VAE_%04d.mat\n',saveDir,n);
    save(sprintf('%sIMS_filt_%04d.mat',saveDir,n),'IMS_filt');
    save(sprintf('%sxyz_VAE_%04d.mat',saveDir,n),'xyzp');
end
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------