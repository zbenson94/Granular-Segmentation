function [Xr,Yr,Zr] = alignZaxis(a,X,Y,Z)
% -------------------------------------------------------------------------
% Rotates an XYZ meshgrid so that new z-axis is pointing along a vector a
% -------------------------------------------------------------------------
    z       = [ 0 0 1 ];  % align it with the z axis
    
    v       = cross(z,a); % cross product
    s       = norm(v);    % magnitude of cross product
    c       = dot(z,a);   % dot product

    v_x     = [   0      -v(3)    v(2) ;... Skew symmetric cross product
                 v(3)      0     -v(1) ;...
                -v(2)     v(1)     0   ];

    Rot     = eye(3) + v_x + v_x ^ 2 .* (1 - c) / s^2;

    sX      = size(X);

    % Perform the rotation
    tmp = [X(:),Y(:),Z(:)]*Rot.';

    Xr = reshape(tmp(:,1),sX); % rotated coordinates
    Yr = reshape(tmp(:,2),sX);
    Zr = reshape(tmp(:,3),sX);
end
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------