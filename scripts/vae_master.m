% vae_master.m
% -------------------------------------------------------------------------
% Author: ZAB
% Date:   late April 2021
% -------------------------------------------------------------------------
% Generates the input for the vae - that is, it generates the individual 
% beads that are the "training" data.
% -------------------------------------------------------------------------
date = '210409';
if(ispc)
    addpath(genpath('X:\Zack\lib\MATLAB\ImageAnalysis'));
end
n      = 6417;
radius = 14;
[IMS_filt,xyzp] = getPositions(date,n,radius);

IMS = zeros([length(xyzp(:,1)),2*radius,2*radius,2*radius]);
for j = 1:length(xyzp(:,1))
    [xc,yc,zc] = isolate_chunk(xyzp(j,:),radius);
    IMS(j,:,:,:) = IMS_filt(xc(1:2*radius),yc(1:2*radius),zc(1:2*radius));
end

save(sprintf('%sBEADS_%04d_%i.mat',saveDir,n,radius),'IMS')
disp(line);
disp('Finished');
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
%%                *** Extract the rest of the positions *** 
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
nScans  = 16;
nCycles = 10;
n0      = 6417;
nf      = n0 + nScans*nCycles;
radius  = 14;
for n = n0:nf 
    [~,~] = getPositions(date,n,radius);
end
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
%%                      *** Post VAE training ***
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% Assuming the fname is 'xyzp_good_%04d.mat'
fname = '%sxyzp_good_%04d.mat';

ext   =  [];

for n = n0:nf
    fprintf('frame: %04d\n',n);
    load(sprintf(fname,saveDir,n),'xyzp');
    ext = [ext;xyzp,frame*ones(length(xyzp(:,1)),1)];
end

% Put it through the tracking Al Gore ithm


% Get the orientations now


% Should be finished at this point
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------
% -------------------------------------------------------------------------